<script context="module">
  import * as Comlink from "comlink";
  export const schild = Comlink.wrap(new Worker("./schild_worker.js"));
  export const repo_worker = Comlink.wrap(new Worker("./repo_worker.js"));
  export const rollup = Comlink.wrap(new Worker("./rollup_worker.js"));
</script>

<script>
  import { configData, repos, connected, schule, user } from './../stores.js';
  import { VERSION } from './../version.js';
  import Main from "./Main.svelte";
  import Intro from "./Intro.svelte";

  const production =  VERSION.production

  function callback(obj) {
    $repos = obj
  }
  const init = async () => {
    try {
      await repo_worker.set_report_location($configData.reports)
      await repo_worker.watch_repos(Comlink.proxy(callback))
      await schild.connect($configData.db)
      $connected = await schild.testConnection()
    } catch (e) {
      console.log(e)
    }
  }
  $: if ($connected) update_ui()

  async function update_ui () {
    $schule = await schild.getSchule()
    console.log('Update UI')
  }
</script>

<style>
  @import "../node_modules/bulma/css/bulma.css";
</style>

{#await init()} Verbinde mit der Datenbank â€¦
{:then weiter}
  {#if $connected && ($user || !production)}
    <Main />
  {:else}
    <Intro />
  {/if}
{:catch}
    <Intro />
{/await}